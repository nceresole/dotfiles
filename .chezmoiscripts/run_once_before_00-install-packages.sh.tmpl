{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# Install Homebrew packages on macOS

set -euo pipefail

echo "Checking Homebrew installation..."

# Install Homebrew if not present
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add Homebrew to PATH for this session
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f "/usr/local/bin/brew" ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
fi

echo "Homebrew installed at: $(which brew)"

# Install packages from Brewfile
CHEZMOI_SOURCE="{{ .chezmoi.sourceDir }}"

if [[ -f "$CHEZMOI_SOURCE/Brewfile" ]]; then
    echo "Installing packages from Brewfile..."
    brew bundle --no-lock --file="$CHEZMOI_SOURCE/Brewfile"
fi

if [[ -f "$CHEZMOI_SOURCE/Brewfile.darwin" ]]; then
    echo "Installing macOS-specific packages..."
    brew bundle --no-lock --file="$CHEZMOI_SOURCE/Brewfile.darwin"
fi

echo "Package installation complete!"
{{ else if eq .chezmoi.os "linux" -}}
#!/bin/bash
# Install packages on Linux

set -euo pipefail

echo "Checking package installation for Linux..."

# Detect package manager
if command -v apt &> /dev/null; then
    PKG_MANAGER="apt"
elif command -v dnf &> /dev/null; then
    PKG_MANAGER="dnf"
elif command -v pacman &> /dev/null; then
    PKG_MANAGER="pacman"
else
    echo "Unknown package manager, skipping system packages"
    PKG_MANAGER=""
fi

# Install essential packages
if [[ -n "$PKG_MANAGER" ]]; then
    case "$PKG_MANAGER" in
        apt)
            sudo apt update
            sudo apt install -y curl git zsh build-essential
            ;;
        dnf)
            sudo dnf install -y curl git zsh @development-tools
            ;;
        pacman)
            sudo pacman -Syu --noconfirm curl git zsh base-devel
            ;;
    esac
fi

# Install Homebrew for Linux if not present
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew for Linux..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    if [[ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]]; then
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    fi
fi

# Install packages from Brewfile
CHEZMOI_SOURCE="{{ .chezmoi.sourceDir }}"

if command -v brew &> /dev/null; then
    if [[ -f "$CHEZMOI_SOURCE/Brewfile" ]]; then
        echo "Installing packages from Brewfile..."
        brew bundle --no-lock --file="$CHEZMOI_SOURCE/Brewfile"
    fi

    if [[ -f "$CHEZMOI_SOURCE/Brewfile.linux" ]]; then
        echo "Installing Linux-specific packages..."
        brew bundle --no-lock --file="$CHEZMOI_SOURCE/Brewfile.linux"
    fi
fi

echo "Package installation complete!"
{{ end -}}
